<!DOCTYPE html>
<html>
  <head>
    <title>Chatbot</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

      function useAutoScroll(dependencies) {
        const chatMessagesRef = React.useRef(null);

        React.useEffect(() => {
          const containerElem = chatMessagesRef.current;
          if( containerElem ){
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        }, [dependencies]);

        return chatMessagesRef;
      }

      function ChatInput( {chatMessages, setChatMessages} ) {
        const [inputText, setInputText] = React.useState('')

        function saveInputText(event) {
          setInputText(event.target.value);
        }

        async function sendMessage() {

          setInputText('');

          const newChatMessages = 
          [
            ...chatMessages,
            {
              message: inputText,
              sender: 'user',
              id: crypto.randomUUID()
            }
          ];

          await setChatMessages(newChatMessages);

          const tempChatMessages = 
          [
            ...newChatMessages,
            {
              message: <img
                className="loading-spinner"
                src="images/loading-spinner.gif"
              />,
              sender: 'robot',
              id: crypto.randomUUID()
            }
          ];

          setChatMessages(tempChatMessages);

          //const response = Chatbot.getResponse(inputText);
          
          const response = await Chatbot.getResponseAsync(inputText);
          setChatMessages([
            ...newChatMessages,
            {
              message: response,
              sender: 'robot',
              id: crypto.randomUUID()
            }
          ]
          );

          
        }

        function enterMessage(event){
          if(event.key === 'Enter'){
            sendMessage();
          }
          if(event.key === 'Escape'){
            setInputText('');
          }
        }

        return (
          <div className="chat-input-container">
            <input 
              size="30" 
              placeholder="Send a message to Chatbot"
              onChange={saveInputText}
              onKeyDown={enterMessage}
              value={inputText}
              className="chat-input"
              />
            <button
              onClick={sendMessage}
              className="send-button"
            >Send</button>
          </div>
            );
      }

      function ChatMessage(props) {
        const {message, sender} = props;
        /*
        if( sender === 'user' ){
          return (
            <div>
              {message}
              <img width="50" src="user.png" />
            </div>
          );
        } else if ( sender === 'robot' ){
          return (
            <div>
              <img width="50" src="robot.png" />
              {message}
            </div>
          );
        }
        */
        return (
          <div className={
            sender === 'user' 
              ? 'chat-message-user' 
              : 'chat-message-robot' 
          }>
            {sender === 'robot' && 
              (<img className="chat-message-profile" src="images/robot.png" />)}
            <div className="chat-message-text">
              {message}
            </div>
            {sender === 'user' && 
              (<img className="chat-message-profile" src="images/user.png" />)}
          </div>
        );
      }

      function ChatMessages({chatMessages}) {

        const chatMessagesRef = useAutoScroll(chatMessages);

        return (
          <div 
          className="chat-messages-container"
          ref={chatMessagesRef}>
            {
              chatMessages.map((chatMessage) => {
                return (
                  <ChatMessage 
                    message={chatMessage.message}
                    sender={chatMessage.sender}
                    key={chatMessage.id}
                  />
                )
              })
            }
          </div>
        );
      }

      function WelocomeMessage({chatMessages}){

        const welcome = 'Welcome to the chatbot project! Send a message using the textbox below.';

        return (
          <p className="welcome-message">
            { chatMessages.length === 0 ? welcome : '' }
          </p>
        );

      }

      function App() {

        const [chatMessages, setChatMessages] = React.useState(
            [
              
            ] 
        );
        
        return (
          <div className="app-container">
          
          <ChatMessages
            chatMessages={chatMessages}
          />

          <WelocomeMessage
            chatMessages={chatMessages}
          />
          <ChatInput 
            chatMessages={chatMessages}
            setChatMessages={setChatMessages}
          />
          </div>
        );
      }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>